/**
 * Archivo con funciones para extender el nucleo de motools
 */


var Drag=new Class({Implements:[Events,Options],options:{snap:6,unit:"px",grid:false,limit:false,handle:false,modifiers:{x:"left",y:"top"}},initialize:function(){var a=Array.link(arguments,{options:Object.type,element:$defined});this.element=$(a.element);this.document=this.element.getDocument();this.setOptions(a.options||{});var b=$type(this.options.handle);this.handles=b=="array"||b=="collection"?$$(this.options.handle):$(this.options.handle)||this.element;this.mouse={now:{},pos:{}};this.value={start:{},now:{}};this.selection=Browser.Engine.trident?"selectstart":"mousedown";this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),eventStop:$lambda(false)};this.attach()},attach:function(){this.handles.addEvent("mousedown",this.bound.start);return this},detach:function(){this.handles.removeEvent("mousedown",this.bound.start);return this},start:function(a){this.fireEvent("onBeforeStart",this.element);this.mouse.start=a.page;var b=this.options.limit;this.limit={x:[],y:[]};for(var c in this.options.modifiers){if(!this.options.modifiers[c])continue;this.value.now[c]=this.element.getStyle(this.options.modifiers[c]).toInt();this.mouse.pos[c]=a.page[c]-this.value.now[c];if(b&&b[c]){for(var d=2;d--;d){if($chk(b[c][d]))this.limit[c][d]=$lambda(b[c][d])()}}}if($type(this.options.grid)=="number")this.options.grid={x:this.options.grid,y:this.options.grid};this.document.addEvents({mousemove:this.bound.check,mouseup:this.bound.cancel});this.document.addEvent(this.selection,this.bound.eventStop)},check:function(a){var b=Math.round(Math.sqrt(Math.pow(a.page.x-this.mouse.start.x,2)+Math.pow(a.page.y-this.mouse.start.y,2)));if(b>this.options.snap){this.cancel();this.document.addEvents({mousemove:this.bound.drag,mouseup:this.bound.stop});this.fireEvent("onStart",this.element).fireEvent("onSnap",this.element)}},drag:function(a){this.mouse.now=a.page;for(var b in this.options.modifiers){if(!this.options.modifiers[b])continue;this.value.now[b]=this.mouse.now[b]-this.mouse.pos[b];if(this.options.limit&&this.limit[b]){if($chk(this.limit[b][1])&&this.value.now[b]>this.limit[b][1]){this.value.now[b]=this.limit[b][1]}else if($chk(this.limit[b][0])&&this.value.now[b]<this.limit[b][0]){this.value.now[b]=this.limit[b][0]}}if(this.options.grid[b])this.value.now[b]-=this.value.now[b]%this.options.grid[b];this.element.setStyle(this.options.modifiers[b],this.value.now[b]+this.options.unit)}this.fireEvent("onDrag",this.element)},cancel:function(a){this.document.removeEvent("mousemove",this.bound.check);this.document.removeEvent("mouseup",this.bound.cancel);if(a){this.document.removeEvent(this.selection,this.bound.eventStop);this.fireEvent("onCancel",this.element)}},stop:function(a){this.document.removeEvent(this.selection,this.bound.eventStop);this.document.removeEvent("mousemove",this.bound.drag);this.document.removeEvent("mouseup",this.bound.stop);if(a)this.fireEvent("onComplete",this.element)}});